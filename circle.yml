general:
  branches:
    ignore:
      - gh-pages
  artifacts:
    - "artifacts/"

machine:
  node:
    version: 6

dependencies:
  cache_directories:
    - "~/.yarn-cache"
    - "~/ghr"

  override:
    - which node

    # install dependencies
    - ./scripts/bootstrap-env-ubuntu.sh

    - yarn install

    # setup ghr
    - >
      if [[ ! -e ~/ghr ]]; then
        curl -L --create-dirs -o ~/ghr/ghr.zip https://github.com/tcnksm/ghr/releases/download/v0.5.0/ghr_v0.5.0_linux_amd64.zip;
        unzip ~/ghr/ghr.zip -d ~/ghr
      fi

test:
  override:
    - node -v
    - npm run lint
    - npm run test-ci
    - npm run check-lockfile
    - npm run build-dist
    - node ./scripts/build-webpack.js
    - ./scripts/build-deb.sh

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: yarnpkg
    commands:
      - ~/ghr/ghr --username yarnpkg --repository yarn --token $KPM_CIRCLE_RELEASE_TOKEN v$(dist/bin/yarn --version) artifacts/
      # TODO(#548): All artifacts should come from artifacts/ directory
      - ~/ghr/ghr --username yarnpkg --repository yarn --token $KPM_CIRCLE_RELEASE_TOKEN v$(dist/bin/yarn --version) dist/yarn-v*.tar.gz
      - ~/ghr/ghr --username yarnpkg --repository yarn --token $KPM_CIRCLE_RELEASE_TOKEN v$(dist/bin/yarn --version) dist/yarn-$(dist/bin/yarn --version).js
      - ~/ghr/ghr --username yarnpkg --repository yarn --token $KPM_CIRCLE_RELEASE_TOKEN v$(dist/bin/yarn --version) dist/yarn-legacy-$(dist/bin/yarn --version).js
      - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - npm publish
